<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebSocket JPEG Preview</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#111; color:#eee; display:flex; flex-direction:column; align-items:center; padding:12px }
    #preview { background:#222; max-width:100%; height:auto; border:1px solid #444 }
    .info { margin-top:8px; color:#bdbdbd }
    .badge { display:inline-block; padding:4px 8px; background:#222; border:1px solid #333; margin-right:8px }
  </style>
</head>
<body>
  <h3>WebSocket JPEG Preview</h3>
  <img id="preview" alt="Waiting for stream..." width="640" height="480" />
  <div class="info">
    <span class="badge">URL: <code id="url">wss://ws.lepin51.com:5683/ws/view</code></span>
    <span class="badge">Recv/s: <strong id="recv">0</strong></span>
    <span class="badge">Last size: <strong id="size">0</strong> bytes</span>
  </div>

  <script>
    // 配置：修改为你的 WS 地址（默认本地演示）
    const WS_URL = 'wss://ws.lepin51.com:5683/ws/view';

    document.getElementById('url').textContent = WS_URL;
    const img = document.getElementById('preview');

    let ws;
    let lastBlobUrl = null;

    // 统计接收速率
    let recvCount = 0;
    let recvLast = 0;
    setInterval(() => {
      document.getElementById('recv').textContent = recvCount - recvLast;
      recvLast = recvCount;
    }, 1000);

    function connect() {
      ws = new WebSocket(WS_URL);
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onerror = (e) => {
        console.error('WebSocket error', e);
      };

      ws.onclose = () => {
        console.warn('WebSocket closed, retry in 1s');
        setTimeout(connect, 1000);
      };

      ws.onmessage = (evt) => {
        // 期望二进制 JPEG
        const ab = evt.data;
        if (!(ab instanceof ArrayBuffer)) return;
        recvCount += 1;
        document.getElementById('size').textContent = ab.byteLength;

        // 创建 Blob URL 并赋值给 img
        const blob = new Blob([ab], { type: 'image/jpeg' });
        const url = URL.createObjectURL(blob);
        // 释放上一个 URL 避免内存泄露
        if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
        lastBlobUrl = url;
        img.src = url;
      };
    }

    connect();

    // 页面卸载时清理
    window.addEventListener('beforeunload', () => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    });
  </script>
</body>
</html>
